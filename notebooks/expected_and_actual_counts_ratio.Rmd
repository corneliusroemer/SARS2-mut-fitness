---
title: "Comparing the Direction and Degree of Selection on Mutations Between SARS-CoV-2 Phylogenetic Clades"
output: html_document
date: "`r format(Sys.Date(), '%d.%m.%Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)

#install.packages("data.table")
#install.packages("ggplot2")
#install.packages("stringr")
#install.packages("gtools")

library(data.table)
library(ggplot2)
library(stringr)
library(gtools)
```

[INSERT] Discuss purpose of notebook and steps to achieve that goal.

First, read in the comma-delimited data from the 'kfeldmann' computational notebook in the Bloom Lab folder on the Fred Hutch server using either access to the server or from github.com.

```{r read_data}
# Read data using access to the Fred Hutch server.
SARS_mutation <- fread("../results/expected_vs_actual_mut_counts/expected_vs_actual_mut_counts.csv", sep=",", header=TRUE)

# Read data from github.com.
#SARS_mutation <- fread("https://media.githubusercontent.com/media/jbloomlab/SARS2-mut-rates/main/results/expected_vs_actual_mut_counts/expected_vs_actual_mut_counts.csv", sep=",", header=TRUE)
```

## Define Filtering and Analysis Parameters

```{r parameters}
# The subset column describes what countries the sequence data came from. Identify what the subset options are.
unique(SARS_mutation$subset)

# Define what subset of the data to analyze.
country <- "all"

# Print the clades that are in the data set (i.e., what clades are possible to include in comparisons).
unique(SARS_mutation$clade)

# Create a list of the clades to include in comparisons.
clades <- c("20A","20B","20C")

# Define a minimum threshold for the number of expected counts. Mutations below this threshold will be removed.
min_expected <- 0

# To avoid infinities when calculating fold-change, add a pseudocount to the observed and expected counts.
pseudo <- 0.5
```

## Filter and Prepare the SARS-CoV-2 Mutation Data

For the analyses conducted in this notebook, subset the data by the country(countries) the sequence data came from. Additionally, remove low-quality mutations or branches with abnormally high mutation rates. Finally, create a column with mutation type (there are 12 possible mutations).

```{r filter_all_data}
# Include data from certain countries AND exclude branches with very high mutation rates and questionable mutations.
filtered_SARS_mutation <- subset(SARS_mutation, subset==country & exclude=="FALSE" & expected_count>=min_expected)

# Add column with the mutation type (clade founder.mutation).
filtered_SARS_mutation$mutation_type <- paste(str_sub(filtered_SARS_mutation$nt_mutation,1,1), ".", str_sub(filtered_SARS_mutation$nt_mutation,-1,-1), sep="")
```

To compare mutations between phylogenetic clades, this notebook will plot volcano plots with p-value on the Y-axis and fold-change on the X-axis. Prior to filtering the data for contingency table analyses, calculate the ratio of observed to expected counts and add a pseudocount to prevent infinities when fold-change is calculated. Mutations with a small count (i.e., 1) are going to be affected by the pseudocount more than mutations with a large count (i.e., 100).

```{r pseudocount}
# Calculate the ratio of actual counts (i.e., observed) to expected counts (i.e., expected) with a pseudocount.
filtered_SARS_mutation$observed_expected <- (filtered_SARS_mutation$actual_count + pseudo)/(filtered_SARS_mutation$expected_count + pseudo)
```

## Characterize the Filtered Data

Take a look at the first 5 rows of the data.

```{r head_data}
head(filtered_SARS_mutation, n=5)
```

Describe the filtered data set.

```{r describe_data}
# How many rows? How many columns?
dim(filtered_SARS_mutation)

# How many phylogenetic clades?
length(unique(filtered_SARS_mutation$clade))

# How many nucleotide sites?
length(unique(filtered_SARS_mutation$nt_site))
```

## Visualize the Filtered Data

[INSERT] information about the plot. Plot to visualize data.

```{r stacked_bar, echo=FALSE}
# Stacked bar graph for the mutation counts normalized by the expected mutation rate for each clade
ggplot(filtered_SARS_mutation, aes(fill=mutation_type, y=actual_count/expected_count, x=clade))+
  geom_bar(position="stack", stat="identity")+
  theme_bw()+
  labs(x="Phylogenetic Clade", y="Normalized Mutation Count")
```

[INSERT] information about the plot. Plot to visualize data.

```{r nucleotide_site, echo=FALSE}
ggplot(filtered_SARS_mutation, aes(color=mutation_type, y=log(actual_count/expected_count), x=nt_site))+
  geom_point()+
  theme_bw()+
  labs(x="", y="")
```

[INSERT] information about the plot. Plot to visualize data.

```{r INSERT, echo=FALSE}
#ggplot(filtered_SARS_mutation, aes(fill=INSERT, y=INSERT, x=INSERT))+
  #geom_tile()+
  #theme_bw()+
  #labs(x="", y="")
```

## Contingency Table Analyses

With such a large data set, it will take potentially hours to calculate the p-values for clade comparisons. To decrease the amount of time it takes to conduct analyses, create a subset of the data with only the clades to be compared.

```{r subset_by_clade}
# Create a subset of the data using only the clades that are going to be compared.
clade_SARS_mutation <- filtered_SARS_mutation[filtered_SARS_mutation$clade %in% clades,]
```

Combine nucleotide site, mutation type and clade to create a reference column in the data set. This column will be referenced to obtain observed and expected counts for clade comparisons. Additionally, remove columns from the data set not necessary for contingency table analyses or creating volcano plots.

```{r filter_contingency_data}
# Filter mutation data for Fisher's Exact test, and combine nucleotide sites, mutation types and clades to make an iterative reference.
fisher_data <- data.frame(nt_mutation_clade=paste(clade_SARS_mutation$nt_site, clade_SARS_mutation$mutation_type, clade_SARS_mutation$clade, sep="_"), observed=clade_SARS_mutation$actual_count, expected=clade_SARS_mutation$expected_count, observed_expected=clade_SARS_mutation$observed_expected)
```

Create a two-column matrix of all possible clade comparisons, each column listing one clade in the comparison. This matrix should have [n x (n-1)]/2 rows where n is the number of clades.

```{r clade_comparisons}
# Create a two-column matrix with all of the possible clade-clade comparisons (each row contains one comparison).
clade_comparisons <- combinations(n=length(clades), r=2, v=clades, repeats.allowed=FALSE)
```

For each mutation type (e.g., A -> T) at each nucleotide site, this notebook will generate contingency table analyses for each comparison in the set of clade comparisons. To expand the clade comparison matrix to include mutation types at nucleotide sites, generate a unique list of each mutation type (i.e., three mutations for one clade founder) at each nucleotide site.

```{r unique_mutations}
# Combine nucleotide sites and mutation types, and filter list to only include unique nucleotide mutations.
nt_mutation_list <- unique(paste(clade_SARS_mutation$nt_site, clade_SARS_mutation$mutation_type, sep="_"))
```

Expand both the clade comparison matrix and the mutation list to create a combined matrix of all possible clade comparisons for each mutation type at each nucleotide site. To do this, repeat the clade comparison matrix by the number of unique mutations, and repeat each mutation in the mutation list by the number of clade comparisons.

```{r combined_clade_comparisons}
# In preparation for combining clade comparisons with unique nucleotide mutations, repeat the nucleotide mutation list by the number of clade comparisons.
rep_nt_mutation <- data.frame(nt_mutation=rep(nt_mutation_list, each=nrow(clade_comparisons)))

# In preparation for combining clade comparisons with unique nucleotide mutations, repeat the clade comparison matrix by the number of unique nucleotide mutations.
rep_clades <- do.call("rbind", replicate(length(nt_mutation_list), clade_comparisons, simplify=FALSE))

# Combine the nucleotide mutations to each column in the clade comparison matrix to create a reference for the fisher data.
comparisons <- data.frame(clade1=paste(rep_nt_mutation$nt_mutation, rep_clades[,1], sep="_"), clade2=paste(rep_nt_mutation$nt_mutation, rep_clades[,2], sep="_"))
```

Not every mutation will exist in each clade. Therefore, remove comparisons where observed and expected count data does not exist for one or both clades in the comparison.

```{r filter_for_comparisons}
# Drop comparisons where the nucleotide site, mutation type, clade reference does not exist in the observed-expected data frame.
# DOUBLE CHECK THIS: NOT CONVINCED IT IS WORKING
filtered_comparisons <- comparisons[comparisons$clade1 %in% fisher_data$nt_mutation_clade & comparisons$clade2 %in% fisher_data$nt_mutation_clade,]
```

To decrease the amount of time it takes to run the contingency tests, add columns to the filtered comparisons data frame with the observed counts, expected counts and observed/expected ratios for clade 1 and clade 2.

```{r contingency_matrix}
# Create an ID to maintain the order of rows (and thus comparisons) after merging data frames.
filtered_comparisons$id <- c(1:nrow(filtered_comparisons))

# Merge each of the clades in the comparison matrix with the data to align observed, expected and observed/expected values.
clade1 <- merge(filtered_comparisons[,c("id","clade1")], fisher_data[,c("nt_mutation_clade","observed","expected","observed_expected")], by.x="clade1", by.y="nt_mutation_clade")
clade2 <- merge(filtered_comparisons[,c("id","clade2")], fisher_data[,c("nt_mutation_clade","observed","expected","observed_expected")], by.x="clade2", by.y="nt_mutation_clade")

# Add observed, expected and observed/expected data to the comparison matrix.
{filtered_comparisons$clade1_observed <- clade1[order(clade1$id),"observed"]
filtered_comparisons$clade1_expected <- clade1[order(clade1$id),"expected"]
filtered_comparisons$clade2_observed <- clade2[order(clade2$id),"observed"]
filtered_comparisons$clade2_expected <- clade2[order(clade2$id),"expected"]
filtered_comparisons$clade1_obs_exp <- clade1[order(clade1$id),"observed_expected"]
filtered_comparisons$clade2_obs_exp <- clade2[order(clade2$id),"observed_expected"]}
```

For each comparison, calculate the probability of obtaining the observed and expected counts assuming there is no difference in selection on mutations between the clades being compared (i.e., p-value) using the Fisher's Exact test. 

```{r contingency_table}
# Iterate through rows and compare clade 1 observed and expected values to clade 2 observed and expected values.
# NOTE: Expected counts are not integers and are therefore rounded for the Fisher's Exact test. 
'p_values <- data.frame(p_value=apply(filtered_comparisons, 1, FUN=function(c) {fisher.test(rbind(c(as.numeric(c[3]),as.numeric(c[4])),c(as.numeric(c[5]),as.numeric(c[6]))))$p.value}))'

# Save and load variable because calculating p-values takes a long time.
'save(p_values, file=paste("pvalues", paste(clades, collapse="_"), ".Rda", sep=""))'
load(paste("pvalues", paste(clades, collapse="_"), ".Rda", sep=""))
```

Combine the p-values calculated using the Fisher's Exact test with the data frame of filtered comparisons.

```{r combine_p_values}
# Combine p-value list with the clade comparison list.
comparison_p_values <- cbind(filtered_comparisons, p_values)
```

## P-Value Correction

```{r p_value_correction}
# Identify clades from the two columns in the comparison matrix and combine into one column.
comparison_p_values$clades <- data.frame(clades=paste(str_split(comparison_p_values$clade1, "_", simplify=TRUE)[,3], str_split(comparison_p_values$clade2, "_", simplify=TRUE)[,3], sep="."))

# Count the number of rows for each clade (i.e., number of hypothesis tests).
clade.table <- table(comparison_p_values$clades)

# Add a column for the number of hypothesis tests conducted for each pair of clades.
comparison_p_values$num_tests <- apply(comparison_p_values$clades, 1, FUN=function(c){clade.table[[c[1]]]})

# Using Bonferroni Correction, adjust the p-values by the number of hypothesis tests.
comparison_p_values$p_values_corrected <- comparison_p_values$p_value/comparison_p_values$num_tests
```

## Volcano Plot

Use a function to calculate fold-change using the observed-expected ratios calculated with a pseudocount. This value will be the X-axis for the volcano plot. P-values clustering less than zero indicate a difference in degree of selection for one clade, whereas p-values clustering greater than zero indicate a similar difference in degree of selection but for the other clade.

```{r fold-change}
# Calculate fold change for plotting volcano plots [clade 1 observed/clade 1 expected]/[clade 2 observed/clade 2 expected].
comparison_p_values$fold_change <- foldchange(comparison_p_values$clade1_obs_exp, comparison_p_values$clade2_obs_exp)
```

Plot the volcano plot with -log10 p-values on the Y-axis and log fold-change on the X-axis.

```{r volcano_plot}
# Only plot data for the two clades being compared.
plot_data <- comparison_p_values[which(comparison_p_values$clades=="20B.20C"),]
ggplot(plot_data, aes(x=fold_change, y=-log10(p_value)))+
  geom_point()
```

## Verify Analyses Using Analyses With Expected Outcomes

```{r verify_analyses}
# sanity check analyses (distribution of synonymous p-values)

```