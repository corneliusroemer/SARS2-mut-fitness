---
title: "Comparing the Direction and Degree of Selection on Mutations Between SARS-CoV-2 Phylogenetic Clades"
output: html_document
date: "2022-10-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("data.table")
#install.packages("ggplot2")
#install.packages("stringr")
#install.packages("gtools")

library(data.table)
library(ggplot2)
library(stringr)
library(gtools)
```

[INSERT] Discuss purpose of notebook and steps to achieve that goal.

## SARS-CoV-2 Mutation Data

First, read in the comma-delimited data from the 'kfeldmann' computational notebook in the Bloom Lab folder on the Fred Hutch server using either access to the server or from github.com.

```{r read_data}
# Read data using access to the Fred Hutch server.
SARS_mutation <- fread("../results/expected_vs_actual_mut_counts/expected_vs_actual_mut_counts.csv", sep=",", header=TRUE)

# Read data from github.com.
#SARS_mutation <- fread("https://media.githubusercontent.com/media/jbloomlab/SARS2-mut-rates/main/results/expected_vs_actual_mut_counts/expected_vs_actual_mut_counts.csv", sep=",", header=TRUE)
```

Next, take a look at the first 5 rows of the data.

```{r head_data}
head(SARS_mutation, n=5)
```

Describe the entire data set.

```{r describe_data}
# How many rows? How many columns?
dim(SARS_mutation)

# How many phylogenetic clades?
length(unique(SARS_mutation$clade))

# How many rows for each subset? Data from all countries, only England or only the United States.
data.frame(all=nrow(SARS_mutation[which(SARS_mutation$subset=="all"),]), England=nrow(SARS_mutation[which(SARS_mutation$subset=="England"),]), USA=nrow(SARS_mutation[which(SARS_mutation$subset=="USA"),]))

# How many nucleotide sites?
length(unique(SARS_mutation$nt_site))

# How many mutations to exclude for each subset?
data.frame(all=nrow(SARS_mutation[which(SARS_mutation$subset=="all" & SARS_mutation$exclude=="TRUE"),]), England=nrow(SARS_mutation[which(SARS_mutation$subset=="England" & SARS_mutation$exclude=="TRUE"),]), USA=nrow(SARS_mutation[which(SARS_mutation$subset=="USA" & SARS_mutation$exclude=="TRUE"),]))
```

## Filter and Prepare the Data

For the analyses conducted in this notebook, subset the data by "all" to include data collected from all countries. Additionally, remove low-quality mutations or branches with abnormally high mutation rates. Finally, create a column with mutation type (there are 12 possible mutations).

```{r filter_all_data}
# Include data from all countries AND exclude branches with very high mutation rates and questionable mutations.
filtered_SARS_mutation <- subset(SARS_mutation, subset=="all" & exclude=="FALSE")

# Add column with the mutation type (clade founder.mutation).
filtered_SARS_mutation$mutation_type <- paste(str_sub(filtered_SARS_mutation$nt_mutation,1,1), ".", str_sub(filtered_SARS_mutation$nt_mutation,-1,-1), sep="")
```

To compare mutations between phylogenetic clades, this notebook will plot volcano plots with p-value on the Y-axis and fold-change on the X-axis. Prior to filtering the data for contingency table analyses, calculate the ratio of observed to expected counts and add a pseudocount to prevent infinities when fold-change is calculated.

```{r pseudocount}
# Calculate the ratio of actual counts (i.e., observed) to expected counts (i.e., expected) with pseudocount of 0.5.
filtered_SARS_mutation$observed_expected <- (filtered_SARS_mutation$actual_count + 0.5)/(filtered_SARS_mutation$expected_count + 0.5)
```

## Visualize Filtered Data

[INSERT] information about the plot. Plot to visualize data.

```{r stacked_bar, echo=FALSE}
# Stacked bar graph for the mutation counts normalized by the expected mutation rate for each clade
ggplot(filtered_SARS_mutation, aes(fill=mutation_type, y=actual_count/expected_count, x=clade))+
  geom_bar(position="stack", stat="identity")+
  theme_bw()+
  labs(x="Phylogenetic Clade", y="Normalized Mutation Count")
```

[INSERT] information about the plot. Plot to visualize data.

```{r nucleotide_site, echo=FALSE}
ggplot(filtered_SARS_mutation, aes(color=mutation_type, y=actual_count/expected_count, x=nt_site))+
  geom_point()+
  theme_bw()+
  labs(x="", y="")
```

[INSERT] information about the plot. Plot to visualize data.

```{r INSERT, echo=FALSE}
#ggplot(filtered_SARS_mutation, aes(fill=INSERT, y=INSERT, x=INSERT))+
  #geom_tile()+
  #theme_bw()+
  #labs(x="", y="")
```

## Contingency Table Analyses

With such a large data set, it will take potentially hours to calculate the p-values for clade comparisons. To decrease the amount of time it takes to conduct analyses, create a subset of the data with only the clades to be compared.

```{r subset_by_clade}
# Create a subset of the data using only the clades that are going to be compared.
clade_SARS_mutation <- filtered_SARS_mutation[which(filtered_SARS_mutation$clade=="20A" | filtered_SARS_mutation$clade=="20B"),]

# Identify unique clades in the dataset.
clades <- unique(clade_SARS_mutation$clade)
```

Combine nucleotide site, mutation type and clade to create a reference column in the data set. This column will be referenced to obtain observed and expected counts for clade comparisons. Additionally, remove columns from the data set not necessary for contingency table analyses or creating volcano plots.

```{r filter_contingency_data}
# Filter mutation data for Fisher's Exact test, and combine nucleotide sites, mutation types and clades to make an iterative reference.
fisher_data <- data.frame(nt_mutation_clade=paste(clade_SARS_mutation$nt_site, clade_SARS_mutation$mutation_type, clade_SARS_mutation$clade, sep="_"), observed=clade_SARS_mutation$actual_count, expected=clade_SARS_mutation$expected_count, observed_expected=clade_SARS_mutation$observed_expected)
```

Create a two-column matrix of all possible clade comparisons, each column listing one clade in the comparison. This matrix should have [n x (n-1)]/2 rows where n is the number of clades.

```{r clade_comparisons}
# Create a two-column matrix with all of the possible clade-clade comparisons (each row contains one comparison).
clade_comparisons <- combinations(n=length(clades), r=2, v=clades, repeats.allowed=FALSE)
```

For each mutation type (e.g., A -> T) at each nucleotide site, this notebook will generate contingency table analyses for each comparison in the set of clade comparisons. To expand the clade comparison matrix to include mutation types at nucleotide sites, generate a unique list of each mutation type (i.e., three mutations for one clade founder) at each nucleotide site.

```{r unique_mutations}
# Combine nucleotide sites and mutation types, and filter list to only include unique nucleotide mutations.
nt_mutation_list <- unique(paste(clade_SARS_mutation$nt_site, clade_SARS_mutation$mutation_type, sep="_"))
```

Expand both the clade comparison matrix and the mutation list to create a combined matrix of all possible clade comparisons for each mutation type at each nucleotide site. To do this, repeat the clade comparison matrix by the number of unique mutations, and repeat each mutation in the mutation list by the number of clade comparisons.

```{r combined_clade_comparisons}
# In preparation for combining clade comparisons with unique nucleotide mutations, repeat the nucleotide mutation list by the number of clade comparisons.
rep_nt_mutation <- data.frame(nt_mutation=rep(nt_mutation_list, each=nrow(clade_comparisons)))

# In preparation for combining clade comparisons with unique nucleotide mutations, repeat the clade comparison matrix by the number of unique nucleotide mutations.
rep_clades <- do.call("rbind", replicate(length(nt_mutation_list), clade_comparisons, simplify=FALSE))

# Combine the nucleotide mutations to each column in the clade comparison matrix to create a reference for the fisher data.
comparisons <- data.frame(clade1=paste(rep_nt_mutation$nt_mutation, rep_clades[,1], sep="_"), clade2=paste(rep_nt_mutation$nt_mutation, rep_clades[,2], sep="_"))
```

Not every mutation will exist in each clade. Therefore, remove comparisons where observed and expected count data does not exist for one or both clades in the comparison.

```{r filter_for_comparisons}
# Drop comparisons where the nucleotide site, mutation type, clade reference does not exist in the observed-expected data frame.
filtered_comparisons <- comparisons[comparisons$clade1 %in% fisher_data$nt_mutation_clade & comparisons$clade2 %in% fisher_data$nt_mutation_clade,]
```

For each comparison, calculate the probability of obtaining the observed and expected counts assuming there is no difference in selection on mutations between the clades being compared (i.e., p-value) using the Fisher's Exact test.

```{r contingency_analysis}
# Save list of p-values for every comparison. NOTE: Expected counts are not integers and are therefore rounded for the Fisher's Exact test.
'p_values <- data.frame(p_value=apply(filtered_comparisons, 1, FUN=function(c) {fisher.test(fisher_data[c(which(fisher_data$nt_mutation_clade==c[1]), which(fisher_data$nt_mutation_clade==c[2])), c("observed","expected")])$p.value}))'

# Save and load variable because calculating p-values takes a long time.
'save(p_values, file="fisher_pvalues.Rda")'
load("fisher_pvalues.Rda")

# Combine p-value list with the clade comparison list.
comparison_p_values <- cbind(filtered_comparisons, p_values)
```

## P-Value Correction

```{r p_value_correction}
# False Discovery Rate and Bonferroni Corrections

```

## Volcano Plot

Use a function to calculate fold-change using the observed-expected ratios calculated with a pseudocount. This value will be the X-axis for the volcano plot. P-values clustering less than zero indicate a difference in degree of selection for one clade, whereas p-values clustering greater than zero indicate a similar difference in degree of selection but for the other clade.

```{r fold-change}
# Calculate fold change for plotting volcano plots [clade 1 observed/clade 1 expected]/[clade 2 observed/clade 2 expected].
comparison_p_values$fold_change <- apply(comparison_p_values[,c("clade1","clade2")], 1, FUN=function(c) {foldchange(fisher_data[which(fisher_data$nt_mutation_clade==c[1]), "observed_expected"], fisher_data[which(fisher_data$nt_mutation_clade==c[2]), "observed_expected"])})
```

Plot the volcano plot with -log10 p-values on the Y-axis and log fold-change on the X-axis.

```{r volcano_plot}
ggplot(comparison_p_values, aes(x=fold_change, y=-log10(p_value)))+
  geom_point()
```

## Verify Analyses Using Analyses With Expected Outcomes

```{r verify_analyses}
# sanity check analyses (distribution of synonymous p-values)

```