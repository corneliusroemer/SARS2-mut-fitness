---
title: "Comparing the Direction and Degree of Selection on Mutations Between SARS-CoV-2 Phylogenetic Clades"
output: html_document
date: "`r format(Sys.Date(), '%d.%m.%Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)

#install.packages("data.table")
#install.packages("ggplot2")
#install.packages("stringr")
#install.packages("gtools")

library(data.table)
library(ggplot2)
library(stringr)
library(gtools)
```

[INSERT] Discuss purpose of notebook and steps to achieve that goal.

First, read in the comma-delimited data from the 'kfeldmann' computational notebook in the Bloom Lab folder on the Fred Hutch server using either access to the server or from github.com.

```{r read_data}
# Read data using access to the Fred Hutch server.
SARS_mutation <- fread("../results/expected_vs_actual_mut_counts/expected_vs_actual_mut_counts.csv", sep=",", header=TRUE)

# Read data from github.com.
#SARS_mutation <- fread("https://media.githubusercontent.com/media/jbloomlab/SARS2-mut-rates/main/results/expected_vs_actual_mut_counts/expected_vs_actual_mut_counts.csv", sep=",", header=TRUE)
```

## Define Filtering and Analysis Parameters

```{r parameters}
# The subset column describes what countries the sequence data came from. Identify what the subset options are.
unique(SARS_mutation$subset)

# Define what subset of the data to analyze.
country <- "all"

# Print the clades that are in the data set (i.e., what clades are possible to include in comparisons).
unique(SARS_mutation$clade)

# Identify the two clades that will be included in comparisons.
clades <- c("20A","22B")

# Define a minimum threshold for the number of expected counts. Mutations below this threshold will be removed.
min_expected <- 0

# To avoid infinities when calculating fold-change, add a pseudocount to the observed and expected counts.
pseudo <- 0.5
```

## Filter and Prepare the SARS-CoV-2 Mutation Data

For the analyses conducted in this notebook, subset the data by the country(countries) the sequence data came from. Additionally, remove low-quality mutations or branches with abnormally high mutation rates. Finally, create a column with mutation type (there are 12 possible mutations).

```{r filter_all_data}
# Include data from certain countries AND exclude branches with very high mutation rates and questionable mutations.
filtered_SARS_mutation <- subset(SARS_mutation, subset==country & exclude=="FALSE" & expected_count>=min_expected)
```

To compare mutations between phylogenetic clades, this notebook will plot volcano plots with p-value on the Y-axis and fold-change on the X-axis. Prior to filtering the data for contingency table analyses, calculate the ratio of observed to expected counts and add a pseudocount to prevent infinities when fold-change is calculated. Mutations with a small count (i.e., 1) are going to be affected by the pseudocount more than mutations with a large count (i.e., 100).

```{r pseudocount}
# Calculate the ratio of actual counts (i.e., observed) to expected counts (i.e., expected) with a pseudocount.
filtered_SARS_mutation$observed_expected <- (filtered_SARS_mutation$actual_count + pseudo)/(filtered_SARS_mutation$expected_count + pseudo)
```

The Fisher's Exact test can only accept integers, so round the expected counts prior to running analyses (i.e., gives control over how values are rounded).

```{r round_expected}
# Round expected counts because contingency table analyses (i.e., Fisher's Exact test) can only analyze integers
filtered_SARS_mutation$rounded_expected <- round(filtered_SARS_mutation$expected_count)
```

## Characterize the Filtered Data

Take a look at the first 5 rows of the data.

```{r head_data}
head(filtered_SARS_mutation, n=5)
```

Describe the filtered data set.

```{r describe_data}
# How many rows? How many columns?
dim(filtered_SARS_mutation)

# How many phylogenetic clades?
length(unique(filtered_SARS_mutation$clade))

# How many nucleotide sites?
length(unique(filtered_SARS_mutation$nt_site))
```

## Visualize the Filtered Data

[INSERT] information about the plot. Plot to visualize data.

```{r stacked_bar, echo=FALSE}
# Add column with the mutation type (clade founder.mutation).
add_mutation <- filtered_SARS_mutation
add_mutation$mutation_type <- paste(str_sub(add_mutation$nt_mutation,1,1), ".", str_sub(add_mutation$nt_mutation,-1,-1), sep="")

# Stacked bar graph for the mutation counts normalized by the expected mutation rate for each clade
ggplot(add_mutation, aes(fill=mutation_type, y=actual_count/expected_count, x=clade))+
  geom_bar(position="stack", stat="identity")+
  theme_bw()+
  labs(x="Phylogenetic Clade", y="Normalized Mutation Count")
```

[INSERT] information about the plot. Plot to visualize data.

```{r nucleotide_site, echo=FALSE}
ggplot(add_mutation, aes(color=mutation_type, y=log(actual_count/expected_count), x=nt_site))+
  geom_point()+
  theme_bw()+
  labs(x="", y="")
```

## Contingency Table Analyses

With such a large data set, it will take potentially hours to calculate the p-values for clade comparisons. To decrease the amount of time it takes to conduct analyses, create a subset of the data with only the clades to be compared.

```{r subset_by_clade}
# Create a subset of the data using only the clades that are going to be compared.
filtered_clades <- filtered_SARS_mutation[filtered_SARS_mutation$clade %in% clades,]
```



```{r restructure_data}
# Create two data frames with data for clade 1 and clade 2.
clade1 <- filtered_clades[which(filtered_clades$clade==clades[1]),c("nt_mutation","clade","actual_count","rounded_expected","observed_expected","synonymous","four_fold_degenerate")]
clade2 <- filtered_clades[which(filtered_clades$clade==clades[2]),c("nt_mutation","clade","actual_count","rounded_expected","observed_expected","synonymous","four_fold_degenerate")]

# Change column names so that clade 1 and clade 2 data frames can be combined
colnames(clade1)[2:ncol(clade1)] <- paste("clade1", colnames(clade1)[2:ncol(clade1)], sep="_")
colnames(clade2)[2:ncol(clade2)] <- paste("clade2", colnames(clade2)[2:ncol(clade2)], sep="_")
colnames(clade1)[which(colnames(clade1)=="clade1_clade")] <- "clade1"
colnames(clade2)[which(colnames(clade2)=="clade2_clade")] <- "clade2"

# Merge the two data frames by mutation so that each row represents one comparison.
filtered_comparisons <- merge(clade1, clade2, by="nt_mutation")
```

For each comparison, calculate the probability of obtaining the observed and expected counts assuming there is no difference in selection on mutations between the clades being compared (i.e., p-value) using the Fisher's Exact test. 

```{r contingency_table}
# Iterate through rows and compare clade 1 observed and expected values to clade 2 observed and expected values.
# NOTE: Expected counts are not integers and are therefore rounded for the Fisher's Exact test. 
'p_values <- data.frame(p_value=apply(filtered_comparisons, 1, FUN=function(c) {fisher.test(rbind(c(as.numeric(c[3]),as.numeric(c[4])),c(as.numeric(c[5]),as.numeric(c[6]))))$p.value}))'

# Save and load variable because calculating p-values takes a long time.
'save(p_values, file=paste("pvalues", paste(clades, collapse="_"), ".Rda", sep=""))'
load(paste("pvalues", paste(clades, collapse="_"), ".Rda", sep=""))
```

Combine the p-values calculated using the Fisher's Exact test with the data frame of filtered comparisons.

```{r combine_p_values}
# Combine p-value list with the clade comparison list.
comparison_p_values <- cbind(filtered_comparisons, p_values)
```

## P-Value Correction

```{r p_value_correction}
# Using Bonferroni Correction, adjust the p-values by the number of hypothesis tests.
comparison_p_values$p_value_corrected <- comparison_p_values$p_value/nrow(comparison_p_values)
```

## Volcano Plot

Use a function to calculate fold-change using the observed-expected ratios calculated with a pseudocount. This value will be the X-axis for the volcano plot. P-values clustering less than zero indicate a difference in degree of selection for one clade, whereas p-values clustering greater than zero indicate a similar difference in degree of selection but for the other clade.

```{r fold-change}
# Calculate fold change for plotting volcano plots [clade 1 observed/clade 1 expected]/[clade 2 observed/clade 2 expected].
# Double check calculation with Jesse's paper
comparison_p_values$fold_change <- log2(comparison_p_values$clade1_observed_expected/comparison_p_values$clade2_observed_expected)
```

Plot the volcano plot with -log10 p-values on the Y-axis and log fold-change on the X-axis.

```{r volcano_plot}
# Only plot data for the two clades being compared.
ggplot(comparison_p_values, aes(x=fold_change, y=-log10(p_value_corrected)))+
  geom_point()+
  theme_bw()
```

## Verify Analyses Using Analyses With Expected Outcomes

```{r verify_analyses}
# sanity check analyses (distribution of synonymous p-values)
verify_analyses <- comparison_p_values
verify_analyses <- comparison_p_values[which(comparison_p_values$clade1_four_fold_degenerate=="TRUE"),]
nb <- sqrt(nrow(verify_analyses))
bw <- (max(verify_analyses$p_value_corrected)-min(verify_analyses$p_value_corrected))/nb
ggplot(verify_analyses, aes(x=p_value_corrected))+
  geom_histogram(bins = nb, binwidth = bw)
```

```{r alternative, echo=FALSE}
# Script that can handle 2+ clades: 1.380048, 1.151285, 1.034135 minutes
# Script that can only handle 2 clades: 50.01184, 58.11915, 58.6249 seconds

# Filter mutation data for Fisher's Exact test, and combine nucleotide sites, mutation types and clades to make an iterative reference.
#filtered_clades$nt_mutation_clade <- paste(filtered_clades$nt_mutation, filtered_clades$clade, sep="_")

# Create a two-column matrix with all of the possible clade-clade comparisons (each row contains one comparison).
#clade_comparisons <- combinations(n=length(clades), r=2, v=clades, repeats.allowed=FALSE)

# In preparation for combining clade comparisons with unique nucleotide mutations, repeat the nucleotide mutation list by the number of clade comparisons.
#rep_nt_mutation <- data.frame(nt_mutation=rep(unique(filtered_clades$nt_mutation), each=nrow(clade_comparisons)))

# In preparation for combining clade comparisons with unique nucleotide mutations, repeat the clade comparison matrix by the number of unique nucleotide mutations.
#rep_clades <- do.call("rbind", replicate(length(unique(filtered_clades$nt_mutation)), clade_comparisons, simplify=FALSE))

# Combine the nucleotide mutations to each column in the clade comparison matrix to create a reference for the fisher data.
#comparisons <- data.frame(clade1=paste(rep_nt_mutation$nt_mutation, rep_clades[,1], sep="_"), clade2=paste(rep_nt_mutation$nt_mutation, rep_clades[,2], sep="_"))

# Drop comparisons where the nucleotide site, mutation type, clade reference does not exist in the observed-expected data frame.
#filtered_comparisons <- comparisons[(comparisons$clade1 %in% filtered_clades$nt_mutation_clade & comparisons$clade2 %in% filtered_clades$nt_mutation_clade),]

# Create an ID to maintain the order of rows (and thus comparisons) after merging data frames.
#filtered_comparisons$id <- c(1:nrow(filtered_comparisons))

# Merge each of the clades in the comparison matrix with the data to align observed, expected and observed/expected values.
#clade1 <- merge(filtered_comparisons[,c("id","clade1")], filtered_clades[,c("nt_mutation_clade","actual_count","rounded_expected","expected_count","observed_expected","synonymous","four_fold_degenerate")], by.x="clade1", by.y="nt_mutation_clade")
#clade2 <- merge(filtered_comparisons[,c("id","clade2")], filtered_clades[,c("nt_mutation_clade","actual_count","rounded_expected","expected_count","observed_expected","synonymous","four_fold_degenerate")], by.x="clade2", by.y="nt_mutation_clade")

# Change column names so that clade 1 and clade 2 data frames can be combined
#colnames(clade1)[3:ncol(clade1)] <- paste("clade1", colnames(clade1)[3:ncol(clade1)], sep="_")
#colnames(clade2)[3:ncol(clade2)] <- paste("clade2", colnames(clade2)[3:ncol(clade2)], sep="_")

# Order clade 1 and clade 2 data frames by id and combine
#fisher_data <- cbind(clade1[order(clade1$id),], clade2[order(clade2$id),])
#fisher_data[,which(colnames(fisher_data) == "id")] <- NULL

# Identify clades from the two columns in the comparison matrix and combine into one column.
#comparison_p_values$clades <- data.frame(clades=paste(str_split(comparison_p_values$clade1, "_", simplify=TRUE)[,2], str_split(comparison_p_values$clade2, "_", simplify=TRUE)[,2], sep="."))

# Count the number of rows for each clade (i.e., number of hypothesis tests).
#clade.table <- table(comparison_p_values$clades)

# Add a column for the number of hypothesis tests conducted for each pair of clades.
#comparison_p_values$num_tests <- apply(comparison_p_values$clades, 1, FUN=function(c){clade.table[[c[1]]]})
```